---
- name: OS Hardening for Linux
  hosts: all
  become: yes
  tasks:
    - name: Disable SELinux
      selinux: state=disabled
      when: ansible_os_family == "RedHat"
    - name: Stop Firewalls
      service:
        name: "{{ (ansible_os_family == 'RedHat') | ternary('firewalld', 'ufw') }}"
        state: stopped
        enabled: no
      ignore_errors: yes

- name: Configure Backend (Netdata)
  hosts: backend
  become: yes
  tasks:
    - name: Install Netdata
      shell: "wget -O /tmp/kickstart.sh https://get.netdata.cloud/kickstart.sh && sh /tmp/kickstart.sh --non-interactive"
    - name: Ensure Port 19999
      lineinfile:
        path: /etc/netdata/netdata.conf
        regexp: 'default port = '
        line: '    default port = 19999'
      notify: Restart Netdata
  handlers:
    - name: Restart Netdata
      service: name=netdata state=restarted

- name: Configure Frontend (Nginx Proxy)
  hosts: frontend
  become: yes
  tasks:
    - name: Install Nginx
      package: name=nginx state=present

    - name: Stop Nginx to clear Port 80
      service: name=nginx state=stopped
      ignore_errors: yes

    - name: Force kill any process on Port 80
      shell: fuser -k 80/tcp || true

    - name: Wipe and Recreate conf.d directory
      file:
        path: /etc/nginx/conf.d
        state: "{{ item }}"
      with_items: [ 'absent', 'directory' ]

    - name: Write Clean nginx.conf
      copy:
        dest: /etc/nginx/nginx.conf
        content: |
          user nginx;
          worker_processes auto;
          error_log /var/log/nginx/error.log;
          pid /run/nginx.pid;
          events { worker_connections 1024; }
          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;
              access_log /var/log/nginx/access.log;
              sendfile on;
              include /etc/nginx/conf.d/*.conf;
          }

    - name: Write Proxy Config
      copy:
        dest: /etc/nginx/conf.d/proxy.conf
        content: |
          server {
              listen 80 default_server;
              location / {
                  proxy_pass http://{{ groups['backend'][0] }}:19999;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
              }
          }

    - name: Validate Nginx Config
      command: nginx -t
      register: config_check

    - name: Final Service Start
      service:
        name: nginx
        state: started
        enabled: yes
      when: config_check.rc == 0
